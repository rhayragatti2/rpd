<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meu Di√°rio üß†</title>
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/3665/3665923.png">
    <link rel="manifest" href="data:application/manifest+json,{%22name%22:%22Meu%20Diario%22,%22short_name%22:%22Diario%22,%22start_url%22:%22.%22,%22display%22:%22standalone%22,%22background_color%22:%22#0f172a%22,%22theme_color%22:%22#6366f1%22,%22icons%22:[{%22src%22:%22https://cdn-icons-png.flaticon.com/512/3665/3665923.png%22,%22sizes%22:%22512x512%22,%22type%22:%22image/png%22}]} ">

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>

    <style>
        :root {
            --bg: #f1f5f9; --card-bg: #ffffff; --text: #1e293b; --text-muted: #64748b;
            --primary: #6366f1; --border: #e2e8f0; --happy: #fde047; --sad: #93c5fd;
            --angry: #fca5a5; --anxious: #c4b5fd; --neutral: #cbd5e1;
        }

        [data-theme="dark"] {
            --bg: #0f172a; --card-bg: #1e293b; --text: #f1f5f9; --text-muted: #94a3b8;
            --border: #334155; --primary: #818cf8;
        }

        body {
            font-family: -apple-system, system-ui, sans-serif;
            background-color: var(--bg); color: var(--text);
            margin: 0; padding: env(safe-area-inset-top) 15px 15px 15px; transition: 0.3s;
        }

        .container { max-width: 600px; margin: 0 auto; }

        .header-row { display: flex; justify-content: space-between; align-items: center; margin: 20px 0; }

        .theme-toggle {
            background: var(--card-bg); border: 1px solid var(--border);
            color: var(--text); padding: 10px; border-radius: 50%; cursor: pointer;
        }

        .card {
            background: var(--card-bg); padding: 20px; border-radius: 16px;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); margin-bottom: 20px;
            border: 1px solid var(--border);
        }

        .insight-badge {
            display: inline-block; background: var(--primary); color: white;
            padding: 4px 10px; border-radius: 12px; font-size: 0.75rem; margin: 3px;
        }

        textarea, select, .search-input {
            width: 100%; padding: 12px; margin-top: 5px;
            border: 1px solid var(--border); border-radius: 8px;
            background: var(--bg); color: var(--text);
            box-sizing: border-box; font-family: inherit; font-size: 16px; /* Evita zoom no iOS */
        }

        button {
            width: 100%; padding: 14px; border: none; border-radius: 12px;
            font-weight: bold; cursor: pointer; transition: 0.2s; margin-top: 10px;
        }

        .btn-save { background: var(--primary); color: white; }
        .btn-pdf { background: #10b981; color: white; margin-bottom: 20px; }

        .chart-container { height: 200px; margin-bottom: 10px; }

        .filters { display: flex; gap: 8px; margin-bottom: 15px; overflow-x: auto; padding-bottom: 5px; }
        .filter-btn {
            background: var(--card-bg); border: 1px solid var(--border); padding: 6px 15px;
            border-radius: 20px; white-space: nowrap; font-size: 0.8rem; color: var(--text);
        }
        .filter-btn.active { background: var(--primary); color: white; }

        .entry {
            border-left: 8px solid; padding: 15px; background: var(--card-bg);
            border-radius: 12px; margin-bottom: 12px; position: relative;
            border: 1px solid var(--border); border-left-width: 8px;
        }
        .entry-title { font-weight: bold; font-size: 0.75rem; color: var(--primary); margin-top: 8px; text-transform: uppercase; }
        .entry-text { font-size: 0.95rem; margin-bottom: 5px; }
        
        .delete-btn { position: absolute; top: 10px; right: 10px; color: #ef4444; background: none; font-size: 0.7rem; width: auto; }
    </style>
</head>
<body>

<div class="container">
    <div class="header-row">
        <h1>Meu Di√°rio üß†</h1>
        <button class="theme-toggle" onclick="toggleTheme()" id="themeBtn">üåô</button>
    </div>

    <div class="card">
        <h3>Insights de Gatilhos</h3>
        <p style="font-size: 0.8rem; color: var(--text-muted)">Palavras frequentes em momentos dif√≠ceis:</p>
        <div id="triggerWords"></div>
        <div class="chart-container"><canvas id="moodChart"></canvas></div>
    </div>

    <div class="card">
        <h3>Novo Registro</h3>
        <select id="mood">
            <option value="happy">üòä Feliz / Radiante</option>
            <option value="neutral">üòê Neutro / Calmo</option>
            <option value="sad">üò¢ Triste / Melanc√≥lico</option>
            <option value="anxious">üò∞ Ansioso / Preocupado</option>
            <option value="angry">üò† Irritado / Bravo</option>
        </select>
        <label>Situa√ß√£o</label><textarea id="situation" rows="2" placeholder="O que houve?"></textarea>
        <label>Emo√ß√µes</label><textarea id="emotions" rows="2"></textarea>
        <label>Pensamentos</label><textarea id="thoughts" rows="2"></textarea>
        <label>Comportamentos</label><textarea id="behavior" rows="2"></textarea>
        <button class="btn-save" onclick="saveEntry()">Salvar no Di√°rio</button>
    </div>

    <button class="btn-pdf" onclick="exportPDF()">üìÑ Exportar PDF Completo</button>

    <div class="search-container">
        <input type="text" id="searchInput" class="search-input" placeholder="üîç Buscar registros..." oninput="render()">
    </div>

    <div class="filters">
        <button class="filter-btn active" onclick="updateView('all', this)">Tudo</button>
        <button class="filter-btn" onclick="updateView('day', this)">Hoje</button>
        <button class="filter-btn" onclick="updateView('week', this)">Semana</button>
        <button class="filter-btn" onclick="updateView('month', this)">M√™s</button>
    </div>

    <div id="entriesList"></div>
</div>

<script>
    let entries = JSON.parse(localStorage.getItem('thought_diary')) || [];
    let myChart;
    let currentFilter = 'all';

    const moodColors = { happy: '#fde047', neutral: '#cbd5e1', sad: '#93c5fd', anxious: '#c4b5fd', angry: '#fca5a5' };
    const moodLabels = { happy: 'Feliz', neutral: 'Neutro', sad: 'Triste', anxious: 'Ansioso', angry: 'Irritado' };

    function toggleTheme() {
        const current = document.documentElement.getAttribute('data-theme');
        const next = current === 'dark' ? 'light' : 'dark';
        document.documentElement.setAttribute('data-theme', next);
        localStorage.setItem('theme', next);
        document.getElementById('themeBtn').innerText = next === 'dark' ? '‚òÄÔ∏è' : 'üåô';
        if(myChart) render();
    }

    // Carregar tema
    if(localStorage.getItem('theme') === 'dark') {
        document.documentElement.setAttribute('data-theme', 'dark');
        document.getElementById('themeBtn').innerText = '‚òÄÔ∏è';
    }

    function saveEntry() {
        const entry = {
            id: Date.now(),
            date: new Date().toISOString(),
            mood: document.getElementById('mood').value,
            situation: document.getElementById('situation').value,
            emotions: document.getElementById('emotions').value,
            thoughts: document.getElementById('thoughts').value,
            behavior: document.getElementById('behavior').value
        };
        if(!entry.situation) return alert("Descreva a situa√ß√£o.");
        entries.unshift(entry);
        localStorage.setItem('thought_diary', JSON.stringify(entries));
        document.querySelectorAll('textarea').forEach(t => t.value = '');
        render();
    }

    function deleteEntry(id) {
        if(confirm("Excluir registro?")) {
            entries = entries.filter(e => e.id !== id);
            localStorage.setItem('thought_diary', JSON.stringify(entries));
            render();
        }
    }

    function calculateTriggers() {
        const negativeMoods = ['sad', 'anxious', 'angry'];
        let textBlob = "";
        entries.filter(e => negativeMoods.includes(e.mood)).forEach(e => {
            textBlob += ` ${e.situation} ${e.thoughts} ${e.emotions}`;
        });

        const words = textBlob.toLowerCase().match(/\b(\w{5,})\b/g) || []; // Palavras com mais de 5 letras
        const counts = {};
        words.forEach(w => { if(!['porque','quando','muito','estou'].includes(w)) counts[w] = (counts[w] || 0) + 1; });

        const sorted = Object.entries(counts).sort((a,b) => b[1] - a[1]).slice(0, 5);
        const container = document.getElementById('triggerWords');
        container.innerHTML = sorted.length ? '' : '<span style="font-size:0.7rem">Ainda sem dados suficientes...</span>';
        sorted.forEach(([word, count]) => {
            container.innerHTML += `<span class="insight-badge">${word} (${count}x)</span>`;
        });
    }

    function initChart() {
        const ctx = document.getElementById('moodChart').getContext('2d');
        const counts = { happy: 0, neutral: 0, sad: 0, anxious: 0, angry: 0 };
        entries.forEach(e => counts[e.mood]++);
        if(myChart) myChart.destroy();
        const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
        myChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: Object.values(moodLabels),
                datasets: [{ data: Object.values(counts), backgroundColor: Object.values(moodColors), borderWidth: 0 }]
            },
            options: { maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { color: isDark ? '#f1f5f9' : '#1e293b', font: { size: 10 } } } } }
        });
    }

    function render() {
        const list = document.getElementById('entriesList');
        const searchTerm = document.getElementById('searchInput').value.toLowerCase();
        list.innerHTML = '';
        const now = new Date();

        const filtered = entries.filter(e => {
            const d = new Date(e.date);
            const matchesSearch = e.situation.toLowerCase().includes(searchTerm) || e.thoughts.toLowerCase().includes(searchTerm);
            let matchesFilter = true;
            if(currentFilter === 'day') matchesFilter = d.toDateString() === now.toDateString();
            if(currentFilter === 'week') matchesFilter = (now - d) / (1000 * 60 * 60 * 24) <= 7;
            if(currentFilter === 'month') matchesFilter = d.getMonth() === now.getMonth() && d.getFullYear() === now.getFullYear();
            return matchesSearch && matchesFilter;
        });

        filtered.forEach(e => {
            const div = document.createElement('div');
            div.className = 'entry';
            div.style.borderLeftColor = moodColors[e.mood];
            div.innerHTML = `
                <button class="delete-btn" onclick="deleteEntry(${e.id})">Apagar</button>
                <div class="entry-date">${new Date(e.date).toLocaleString('pt-BR')}</div>
                <div class="entry-title">Situa√ß√£o</div><div class="entry-text">${e.situation}</div>
                <div class="entry-title">Pensamentos</div><div class="entry-text">${e.thoughts}</div>
            `;
            list.appendChild(div);
        });
        initChart();
        calculateTriggers();
    }

    function updateView(type, btn) {
        currentFilter = type;
        document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        render();
    }

    async function exportPDF() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        doc.text("Relatorio de Pensamentos - RPD", 14, 15);
        const rows = entries.map(e => [new Date(e.date).toLocaleDateString('pt-BR'), moodLabels[e.mood], e.situation, e.thoughts]);
        doc.autoTable({ head: [['Data', 'Humor', 'Situacao', 'Pensamentos']], body: rows, startY: 25, styles: { fontSize: 8 } });
        doc.save("meu-diario.pdf");
    }

    render();
</script>
</body>
</html>
